{% extends "layout1.html" %}
{% import "_macros.html" as macros %}
{% from "_macros.html" import input_forms %}

{% block content %}

<style>
    body {
        background-color: #ffffff;
    }
    .table {
        width: 80%; /* Establece el ancho máximo de la tabla */
        margin: 0 auto; /* Centra la tabla en la página */
        font-family: 'Times New Roman', Times, serif; /* Cambia la fuente de la tabla */
        font-size: 16px; /* Cambia el tamaño de la fuente de la tabla */
        background-color: #c29b61; /* Color de fondo de la tabla */
    }

    /* Estilo para las celdas de encabezado */
    .table th {
        background-color: #008f39 ; /* Color de fondo del encabezado */
        color: #ffffff; /* Color del texto del encabezado */
    }

    /* Estilo para las filas impares */
    .table tbody tr:nth-child(odd) {
        background-color: #008f39 ; /* Color de fondo de las filas impares */
    }

    /* Estilo para las filas pares */
    .table tbody tr:nth-child(even) {
        background-color: #FFFFFF; /* Color de fondo de las filas pares */
    }

    /* Estilo para resaltar la fila seleccionada */
    .selected-row {
        background-color: #DAB785;
    }

    /* Estilo para el título */
    .titulo {
        font-size: 32px; /* Tamaño de la fuente del título */
        color: white; /* Color del título */
        text-align: center; /* Centra el texto */
        margin-top: 20px; /* Margen superior */
        margin-bottom: 30px; /* Margen inferior */
        background-color: #35682D; /* Fondo del título */
        padding: 10px; /* Espacio alrededor del texto */
        transition: background-color 0.5s ease; /* Animación */
    }

    /* Cambia el color de fondo del título al pasar el cursor */
    .titulo-receta:hover {
        background-color: #804008;
        color: white;
    }

    

    .titulo-receta {
        cursor: pointer; 
        font-size: 32px; /* Tamaño de la fuente del título */
        color: #3E3E3E; /* Color del título */
        text-align: center; /* Centra el texto */
        margin-top: 20px; /* Margen superior */
        border: 1px solid green; /* Cambia el color según lo necesites */
        margin-bottom: 30px; /* Margen inferior */ /* Fondo del título */
        padding: 10px; /* Espacio alrededor del texto */
        transition: background-color 0.5s ease; /* Animación *//* Cambia el cursor a un puntero */
    }
    
</style>
{% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
        {% for category, message in messages %}
            <div class="alert alert-{{ category }}">
                {{ message }}
            </div>
        {% endfor %}
    {% endif %}
{% endwith %}
<div class="titulo">
Recetas
<br>
<!-- Botones para abrir los formularios en una ventana modal -->

    <button type="button" class="btn btn-success" data-toggle="modal" data-target="#nuevaGalletaModal">Registrar Nueva Galleta</button>
    <button type="button" class="btn btn-success" data-toggle="modal" data-target="#nuevaRecetaModal">Registrar Ingredientes a Receta</button>
    <button type="button" class="btn btn-danger" data-toggle="modal" data-target="#eliminarRecetaModal">Eliminar Receta</button>
    <div class="text-center mt-4">
        <a href="{{ url_for('recetas.calcular_utilidades') }}" class="btn btn-success">Utilidades</a>
    </div>
</div>

<!-- Formulario de registro de galleta -->
<div class="modal fade" id="nuevaGalletaModal" tabindex="-1" role="dialog" aria-labelledby="nuevaGalletaModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="nuevaGalletaModalLabel">Registrar Nueva Galleta</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="galletaForm" action="/recetas" method="post" enctype="multipart/form-data">
                    {{ input_forms(galleta_form.nombre, class="form-control form-control-sm") }}
                    {{ input_forms(galleta_form.descripcion, class="form-control form-control-sm") }}
                    {{ input_forms(galleta_form.precio, class="form-control form-control-sm") }}
                    {{ input_forms(galleta_form.peso, class="form-control form-control-sm") }}
                    <!-- Campo para subir la imagen -->
                    <div class="form-group">
                    {{ input_forms(galleta_form.imagen, class="form-control form-control-sm") }}
                    </div>
                    <button type="submit" name="crear_galleta" class="btn btn-primary">Crear Galleta</button>
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                </form>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="eliminarRecetaModal" tabindex="-1" role="dialog" aria-labelledby="eliminarRecetaModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="nuevaRecetaModalLabel">Eliminar Receta</h5>
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form method="post" action="{{ url_for('recetas.eliminar_receta') }}">
                    <!-- Comienza el menú desplegable. El valor de cada opción es el ID de una galleta -->
                        {{ input_forms(recetas_form.idGalleta, class="form-control form-control-sm", id="idGalleta") }}
                    <!-- Botón de envío del formulario -->
                    <input type="submit" value="Eliminar Galleta">
                    <!-- Campo oculto para el token CSRF -->
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                </form>
            </div>
        </div>
    </div>
</div>


 <!-- Formulario de registro de recetas -->
 <div class="modal fade" id="nuevaRecetaModal" tabindex="-1" role="dialog" aria-labelledby="nuevaRecetaModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="nuevaRecetaModalLabel">Registrar Nueva Receta</h5>
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="recetaForm" action="/recetas" method="post">
                    <!-- Campos del formulario de receta -->
                    <div class="form-group">
                      
                        {{ input_forms(recetas_form.idGalleta, class="form-control form-control-sm", id="idGalleta") }}
                    </div>
                    <div class="form-group">
                        
                        {{ input_forms(recetas_form.idMp, class="form-control form-control-sm", id="idMp") }}
                    </div>
                    <div class="form-group">
                        {{ input_forms(recetas_form.cantidad, class="form-control form-control-sm", id="cantidad") }}
                    </div>
                    <ul id="ingredientList" class="ingredient-list"></ul>
                    <button type="button" id="agregarIngrediente" class="btn btn-success">Agregar Ingrediente</button>
                    <button type="submit" name="crear_receta" class="btn btn-primary">Registrar Receta</button>
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                </form>
            </div>
        </div>
    </div>
</div>
<!-- Comienza el formulario. Cuando se envía, realiza una solicitud POST a la ruta 'eliminar_receta' -->

<!-- Tabla de recetas -->
{% for idGalleta, recetas in recetas_agrupadas.items() %}
{% set galleta = recetas[0]['galleta'] %}
<div class="receta-container">
    <div class="text-center mb-3 titulo-receta">
        <h2>{{ galleta }}</h2>
    </div>
    <div class="table-responsive tabla-receta" style="display: none;">
        <table class="table table-striped table-bordered">
        <thead >
            <tr>
                <th>Ingrediente</th>
                <th>Cantidad</th>
                <th>Medición</th>
                <!-- Añadir más columnas si es necesario -->
            </tr>
        </thead>
        <tbody>
            {% for receta in recetas %}
            <tr>
                <td>{{ receta.ingrediente }}</td>
                <td>{{ receta.cantidad }}</td>
                <td>{{ receta.medicion }}</td>
                <!-- Añadir más celdas si es necesario -->
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endfor %}


<script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
<!-- jQuery -->
<script>
    $(document).ready(function() {
        // Resto del código JavaScript

        // Agregar evento de clic a los títulos de las recetas
        $(".titulo-receta").click(function() {
            // Buscar la tabla correspondiente y cambiar su visibilidad
            $(this).next(".tabla-receta").toggle();
        });

        // Lista de ingredientes seleccionados
        var ingredientList = [];

        function agregarIngrediente() {
            var nombreIngrediente = $("#idMp option:selected").text();
            var cantidad = parseFloat($("#cantidad").val());
            var idGalleta = $("#idGalleta").val();
            var idMp = $("#idMp").val(); // Obtener el valor de idMp
        
            // Validar que la cantidad sea mayor que cero
            if (cantidad <= 0) {
                swal("Error", "La cantidad debe ser mayor que cero", "error");
                return; // Salir de la función si la cantidad es inválida
            }

            // Verificar si el ingrediente ya existe en la lista
            var ingredienteExistente = ingredientList.find(function(ingrediente) {
                return ingrediente.idMp === idMp && ingrediente.idGalleta === idGalleta;
            });
        
            if (ingredienteExistente) {
                // Si el ingrediente ya existe, preguntar al usuario si desea reemplazarlo
                swal({
                    title: "Ingrediente Existente",
                    text: "Este ingrediente ya está registrado para esta galleta",
                    icon: "warning",
                    buttons: "OK",
                    dangerMode: true,
                }).then((willDelete) => {
                    if (willDelete) {
                        // Si el usuario confirma, reemplazar el ingrediente
                        ingredienteExistente.nombre = nombreIngrediente;
                        ingredienteExistente.cantidad = cantidad;
                    } else {
                        swal("El ingrediente no ha sido reemplazado.");
                    }
                });
            } else {
                // Si el ingrediente no existe, agregarlo a la lista
                ingredientList.push({ nombre: nombreIngrediente, cantidad: cantidad, idGalleta: idGalleta, idMp: idMp });

                // Bloquear el campo de selección de galleta después de agregar el primer ingrediente
                if (ingredientList.length === 1) {
                    $("#idGalleta").prop("disabled", true);
                }
            }
            
            // Mostrar la lista actualizada en la interfaz
            mostrarListaIngredientes();
        }

        // Función para mostrar la lista de ingredientes en la interfaz
        function mostrarListaIngredientes() {
            // Limpiar la lista actual
            $("#ingredientList").empty();

            // Crear la tabla de ingredientes
            var table = $("<table class='table table-striped'></table>");
            var thead = $("<thead></thead>").appendTo(table);
            var tbody = $("<tbody></tbody>").appendTo(table);

            // Agregar encabezados de la tabla
            var headerRow = $("<tr></tr>").appendTo(thead);
            $("<th>Ingrediente</th>").appendTo(headerRow);
            $("<th>Cantidad</th>").appendTo(headerRow);
            $("<th>ID Galleta</th>").appendTo(headerRow);
            $("<th></th>").appendTo(headerRow); // Espacio para el botón Eliminar

            // Agregar cada ingrediente a la tabla
            ingredientList.forEach(function(ingrediente, index) {
                var row = $("<tr></tr>").appendTo(tbody);
                $("<td></td>").text(ingrediente.nombre).appendTo(row);
                $("<td></td>").text(ingrediente.cantidad).appendTo(row);
                $("<td></td>").text(ingrediente.idGalleta).appendTo(row);
                
                // Agregar botón Eliminar
                var deleteButton = $("<button class='btn btn-danger btn-sm'>Eliminar</button>").click(function() {
                    // Eliminar el ingrediente de la lista
                    ingredientList.splice(index, 1);
                    // Mostrar la lista actualizada
                    mostrarListaIngredientes();
                    // Si no hay ingredientes, habilitar el campo de selección de galleta
                    if (ingredientList.length === 0) {
                        $("#idGalleta").prop("disabled", false);
                    }
                });
                $("<td></td>").append(deleteButton).appendTo(row);
            });

            // Agregar la tabla al contenedor
            $("#ingredientList").append(table);
        }

        $("#agregarIngrediente").click(function() {
            agregarIngrediente();
        });

        $("#recetaForm").submit(function() {
            // Convertir la lista de ingredientes a texto
            var ingredientText = JSON.stringify(ingredientList);

            // Agregar el campo oculto al formulario
            $("<input>").attr({
                type: "hidden",
                name: "ingredientes_texto",
                value: ingredientText
            }).appendTo("#recetaForm");
            return true;
        });
    });
</script>
{% endblock %}
